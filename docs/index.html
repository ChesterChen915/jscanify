<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>照片剪裁測試工具</title>

    <style>
        html, body {
            margin: 0;
        }

        * {
            font-family: system-ui;
        }

        h1{
            font-weight: 400;
        }

        canvas {
            max-height: 600px;
            max-width: 600px;
        }
    </style>
</head>

<body>
    <div style="padding: 30px">
        <h1 style="margin: 0">測試剪裁工具</h1>

        <input type="file" accept="image/*" capture="camera" id="fileInput">
        <!-- file input for capturing images -->

        <canvas id="originalCanvas"></canvas>
        <!-- original image -->
        <canvas id="highlightedCanvas"></canvas>
        <!-- highlighted image -->

        
    </div>
    
    <div>
        <!-- 新增的下載按鈕，初始時設置為不顯示 -->
        <button id="downloadButton" style="display: none;" onclick="downloadHighlightedCanvas()">下載 Highlighted 圖片</button>
    </div>

    <script src="https://docs.opencv.org/4.7.0/opencv.js" async></script>
    <!-- warning: loading OpenCV can take some time. Load asynchronously -->
    <script src="https://cdn.jsdelivr.net/gh/ColonelParrot/jscanify@master/src/jscanify.min.js"></script>

    <script>
        window.addEventListener("load", function () {
            const scanner = new jscanify();
            const originalCanvas = document.getElementById("originalCanvas");
            const highlightedCanvas = document.getElementById("highlightedCanvas");
            const originalCanvasCtx = originalCanvas.getContext("2d");
            const highlightedCanvasCtx = highlightedCanvas.getContext("2d");

            const fileInput = document.getElementById("fileInput");
            const downloadButton = document.getElementById("downloadButton");

            fileInput.addEventListener("change", function (event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();    
                    reader.onload = function (e) {
                        const image = new Image();
                        image.src = e.target.result;

                        image.onload = function () {
                            originalCanvas.width = image.width;
                            originalCanvas.height = image.height;

                            // Draw the original image on the canvas
                            originalCanvasCtx.drawImage(image, 0, 0);

                            // Highlight the paper and draw it on the highlighted canvas
                            const resultCanvas = scanner.highlightPaper(originalCanvas);
                            highlightedCanvas.width = resultCanvas.width;
                            highlightedCanvas.height = resultCanvas.height;
                            highlightedCanvasCtx.drawImage(resultCanvas, 0, 0);

                            // 顯示下載按鈕
                            downloadButton.style.display = "block";
                        };
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        // 新增的下載函數
        function downloadHighlightedCanvas() {
            const highlightedCanvas = document.getElementById("highlightedCanvas");
            const dataUrl = highlightedCanvas.toDataURL("image/png");
            
            // 創建一個a標籤用於下載
            const a = document.createElement("a");
            a.href = dataUrl;
            a.download = "highlighted_image.png";
            
            // 模擬點擊下載
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>
