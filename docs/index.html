<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>照片梯形修正與裁切測試工具</title>

    <style>
        html, body {
            margin: 0;
        }

        * {
            font-family: system-ui;
        }

        h1{
            font-weight: 400;
        }

        canvas {
            max-height: 400px;
            max-width: 400px;
        }

        /* 新增的樣式，用於定位下載按鈕 */
        #downloadButtonContainer {
            margin-top: 10px; /* 調整上邊距，使下載按鈕與 highlightedCanvas 之間有些間距 */
        }
    </style>
</head>

<body>
    <div style="padding: 30px">
        <h1 style="margin: 0">測試剪裁工具</h1>

        <!-- file input for capturing images -->
        <input type="file" accept="image/*" capture="camera" id="fileInput">

        <!-- 第一張圖片，拍照或上傳的原始圖片 -->
        <canvas id="originalCanvas"></canvas>

        <!-- 第二張圖片，拍照或上傳的圖片並標示文件邊界 -->
        <canvas id="highlightedCanvas"></canvas>

        <!-- 第三張圖片，標示的範圍 -->
        <canvas id="extractedCanvas"></canvas>

        <!-- 下載按鈕的容器 -->
        <div id="downloadButtonContainer">
            <!-- 下載按鈕，初始時設置為不顯示 -->
            <button id="downloadButton" style="display: none;" onclick="downloadExtractedCanvas()" ontouchend="downloadExtractedCanvas()">下載剪裁過後的圖片</button>
        </div>
    </div>

    <script src="https://docs.opencv.org/4.7.0/opencv.js" async></script>
    <!-- warning: loading OpenCV can take some time. Load asynchronously -->
    <script src="https://cdn.jsdelivr.net/gh/ColonelParrot/jscanify@master/src/jscanify.min.js"></script>

    <script>
        window.addEventListener("load", function () {
            const scanner = new jscanify();
            const paperWidth = 800;
            const paperHeight = 1000;

            const originalCanvas = document.getElementById("originalCanvas");
            const highlightedCanvas = document.getElementById("highlightedCanvas");
            const extractedCanvas = document.getElementById("extractedCanvas");

            const originalCanvasCtx = originalCanvas.getContext("2d");
            const highlightedCanvasCtx = highlightedCanvas.getContext("2d");

            const fileInput = document.getElementById("fileInput");
            const downloadButton = document.getElementById("downloadButton");

            fileInput.addEventListener("change", function (event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();    
                    reader.onload = function (e) {
                        const image = new Image();
                        image.src = e.target.result;

                        image.onload = function () {
                            originalCanvas.width = image.width;
                            originalCanvas.height = image.height;

                            // 在第一個Canvas上繪製原始圖像
                            originalCanvasCtx.drawImage(image, 0, 0);

                            // 在第二個Canvas上繪製原始圖像
                            highlightedCanvas.width = image.width;
                            highlightedCanvas.height = image.height;
                            highlightedCanvasCtx.drawImage(image, 0, 0);

                            // Highlight凸顯出文件邊界並將其繪製在第二個Canvas上
                            const resultCanvas = scanner.highlightPaper(originalCanvas);
                            highlightedCanvasCtx.drawImage(resultCanvas, 0, 0);

                            // 將裁剪區域從highlightCanvas繪製到extractedCanvas上
                            const extractedCanvasResult = scanner.extractPaper(image, paperWidth, paperHeight);
                            extractedCanvas.width = extractedCanvasResult.width;
                            extractedCanvas.height = extractedCanvasResult.height;
                            extractedCanvas.getContext("2d").drawImage(extractedCanvasResult, 0, 0);                

                            // 顯示下載按鈕
                            downloadButton.style.display = "block";
                        };
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        // 下載已裁切且梯形修正圖片的方法
        function downloadExtractedCanvas() {
            const extractedCanvas = document.getElementById("extractedCanvas");
            const dataUrl = extractedCanvas.toDataURL("image/png");
            
            // 創建一個a標籤用於下載
            const a = document.createElement("a");
            a.href = dataUrl;
            a.download = "cropped_image.png";
            
            // 模擬點擊下載
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>

</html>
